<tool id="dataset-exporter" name="Dataset Exporter" version="0.3.0" profile="18.01">
    <description>- transfer datasets to network shares</description>
    <requirements>
    </requirements>
    <macros>
        <import>predefined_export_paths.xml</import>
    </macros>
    <command detect_errors="exit_code"><![CDATA[
        #set is_admin = $__user_email__ in $__admin_users__
        python '$__tool_directory__/dataset_export.py'
            --email '$__user_email__'
            --username '$__user_name__'

            #if $collection:
                #for $d in $collection:
                    #set tags = ','.join(str(t.value) for t in $d.tags)
                    --dataset '${d}'
                    --dataset_name '${d.element_identifier}'
                    --dataset_extension '${d.ext}'
                    --collection_name '${collection.element_identifier}'
                    --dataset_tags '${tags}'
                    --history_id '${d.hid}'
                    --history_name '${d.dataset.history.name}'
                #end for
            #end if
            #if $datasets:
                #for $d in $datasets
                    #set tags = ','.join(str(t.value) for t in $d.tags)
                    --dataset '${d}'
                    --dataset_name '${d.element_identifier}'
                    --dataset_extension '${d.ext}'
                    --collection_name ''
                    --dataset_tags '${tags}'
                    --history_id '${d.hid}'
                    --history_name '${d.dataset.history.name}'
                #end for
            #end if

            #if str( $options.selection_mode ) == "defaults":
                --file_pattern '${options.predefined_file_pattern}'
            #else:
                --file_pattern '${options.file_pattern}'
            #end if
            --log '$log'
            #if $is_admin:
                --skip_user_permission_check
            #end if
            #if $dry_run:
                --dry_run
            #end if
            #if $primary_group:
                --run_with_primary_group
            #end if
    ]]></command>
    <inputs>
        <param name="datasets" type="data" format="data" multiple="true" label="Datasets to export" optional="true"
               help="Select one or more datasets to export. Or select a collection below!"/>
        <param name="collection" type="data_collection" format="data" label="Collection to export" optional="true"
               help="Select a collection to export, you can use the name of the collection through the {collection}
               placeholder in the file pattern below."/>
        <conditional name="options">
            <param label="Use advanced options" name="selection_mode" type="select">
              <option selected="true" value="defaults">Use default options</option>
              <option value="advanced">Use advanced options</option>
            </param>
            <when value="defaults">
                <expand macro="predefined_export_paths"/>
            </when>
            <when value="advanced">
                <param name="file_pattern" type="text" label="File pattern (see below for placeholders}"
                       help="Where the file needs to placed and how the name should be constructed."
                       value="/scratch/{username}/{history}/{name}_{tags}.{ext}">
                            <validator type="empty_field" />
                            <sanitizer sanitize="false" />
                </param>
            </when>
        </conditional>
        <param name="primary_group" type="boolean" label="Try to create directory and files with your primary group" checked="true"
               help="Generally this is the recommend option. If you uncheck this, galaxy will export files with the permissive 777."/>
        <param name="dry_run" type="boolean" label="Only do a dry run"
               help="No directories will be created or files written! Very useful to find the right pattern!"/>
    </inputs>
    <outputs>
        <data name="log" format="txt" />
    </outputs>
    <help><![CDATA[

        help_macro

        **File Pattern** Available placeholders are:

            - {username}: your username
            - {email}: your email address
            - {group}: your **primary** unix group
            - {id}: Dataset id
            - {name}: Dataset name
            - {ext}: Dataset extension (e.g. bam, fa)
            - {collection}: Collection name, **only available** for 'Collection to export' inputs. Will be ignored otherwise.
            - {history}: history name
            - {tags}: all tags on the dataset seperated by a dash e.g. myfasta_tag1-tag2.fa
            - {hid}: Galaxy history id

            E.g. "/g/{group}/{username}/{history}/{name}_{tags}.{ext}" will become: "/g/gbcs/scholtal/My_History/myfasta_tag1-tag2.fa"

        **Note:** File paths cannot contain any whitespaces, they will be converted to underscores(_)
    ]]></help>
</tool>
